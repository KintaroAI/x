{% extends "base.html" %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <h1 class="text-4xl font-bold text-gray-900 mb-8">X Scheduler</h1>
    
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Hello World Example</h2>
        
        <button
            hx-get="/api/hello"
            hx-target="#response"
            hx-swap="innerHTML"
            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors"
        >
            Call API
        </button>
        
        <div id="response" class="mt-4 p-4 bg-gray-100 rounded border border-gray-300">
            <p class="text-gray-600">Click the button to see the API response</p>
        </div>
        
        <script>
            document.body.addEventListener('htmx:afterSwap', function(evt) {
                // Format JSON responses nicely
                if (evt.detail.target.id === 'response') {
                    const target = evt.detail.target;
                    try {
                        const data = JSON.parse(target.innerHTML);
                        target.innerHTML = `
                            <pre class="bg-white p-4 rounded border border-gray-300 overflow-x-auto">
                                <code class="text-sm">${JSON.stringify(data, null, 2)}</code>
                            </pre>
                        `;
                    } catch (e) {
                        // Not JSON, leave as is
                    }
                }
            });
        </script>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Status</h2>
        <div hx-get="/health" hx-trigger="load" hx-swap="innerHTML">
            <p class="text-gray-600">Loading...</p>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6 mt-6">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">How it works</h2>
        <div class="space-y-3 text-gray-700">
            <p><strong>1. HTMX:</strong> Click "Call API" to trigger an AJAX request without writing JavaScript.</p>
            <p><strong>2. FastAPI:</strong> The backend serves both HTML and API endpoints.</p>
            <p><strong>3. Tailwind CSS:</strong> Styling is done with utility classes.</p>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6 mt-6">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Twitter Profile Loader</h2>
        
        <div class="mb-4">
            <label for="twitter-username" class="block text-sm font-medium text-gray-700 mb-2">
                Username
            </label>
            <div class="flex space-x-2">
                <input
                    type="text"
                    id="twitter-username"
                    name="username"
                    placeholder="username or @username"
                    class="flex-1 px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                <button
                    hx-post="/api/twitter/profile"
                    hx-target="#twitter-profile-result"
                    hx-swap="innerHTML"
                    hx-include="#twitter-username"
                    hx-trigger="click"
                    hx-indicator="#twitter-loading"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded transition-colors"
                >
                    Load Profile
                </button>
            </div>
            <div id="twitter-loading" class="htmx-indicator mt-2">
                <p class="text-blue-600">Loading profile...</p>
            </div>
        </div>
        
        <div id="twitter-profile-result">
            <div class="bg-gray-50 border border-gray-200 rounded p-4 text-gray-600 text-center">
                Enter a username and click "Load Profile" to see the Twitter profile
            </div>
        </div>
        
        <script>
            // Handle Twitter profile loading
            document.body.addEventListener('htmx:afterRequest', function(evt) {
                if (evt.detail.pathInfo === '/api/twitter/profile') {
                    const target = evt.detail.target;
                    if (target.id === 'twitter-profile-result') {
                        // Parse JSON if successful
                        if (evt.detail.xhr.status === 200) {
                            try {
                                const data = JSON.parse(evt.detail.xhr.responseText);
                                const bio = data.bio || "No bio available";
                                const profileImageUrl = data.profile_image_url || "";
                                const profileUrl = data.profile_url;
                                const username = data.username;
                                const name = data.name;
                                
                                let html = `
                                    <div class="bg-white border border-gray-300 rounded-lg p-6">
                                        <div class="flex items-start space-x-4">
                                            ${profileImageUrl ? `<img src="${profileImageUrl}" alt="Profile" class="w-16 h-16 rounded-full">` : '<div class="w-16 h-16 bg-gray-300 rounded-full"></div>'}
                                            <div class="flex-1">
                                                <h3 class="text-xl font-semibold text-gray-900">${name}</h3>
                                                <p class="text-blue-600 hover:text-blue-800">
                                                    <a href="${profileUrl}" target="_blank" rel="noopener noreferrer" class="font-medium">
                                                        @${username}
                                                    </a>
                                                </p>
                                                <p class="text-gray-700 mt-2">${bio}</p>
                                                <p class="text-sm text-gray-500 mt-2">
                                                    Verified: ${data.verified ? '✓' : '✗'} | Followers: ${data.followers_count.toLocaleString()}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                target.innerHTML = html;
                            } catch (e) {
                                // Not JSON, leave as is
                            }
                        } else {
                            // Error occurred, parse JSON error message
                            try {
                                const error = JSON.parse(evt.detail.xhr.responseText);
                                target.innerHTML = `
                                    <div class="bg-red-50 border border-red-300 rounded p-4 text-red-700">
                                        Error: ${error.error || 'Failed to load profile'}
                                    </div>
                                `;
                            } catch (e) {
                                // Response isn't JSON
                            }
                        }
                    }
                }
            });
        </script>
    </div>

    <div class="bg-white rounded-lg shadow p-6 mt-6">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Audit Log (Latest 10 Records)</h2>
        
        <button
            hx-post="/api/audit-log/test"
            hx-target="#audit-response"
            hx-swap="innerHTML"
            hx-trigger="click"
            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition-colors mb-4"
        >
            Add Test Record
        </button>
        
        <div id="audit-response" class="mb-4"></div>
        
        <div id="audit-log-container" class="mt-4">
            <div hx-get="/api/audit-log/html" hx-trigger="load, refresh-audit from:body" hx-swap="outerHTML">
                <p class="text-gray-600">Loading audit log...</p>
            </div>
        </div>
    </div>

    <script>
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            // After any htmx request, check if we need to refresh audit log
            if (evt.detail.pathInfo === '/api/audit-log/test') {
                // Trigger refresh of audit log after creating test record
                htmx.trigger(htmx.find('#audit-log-container'), 'refresh-audit');
            }
        });

        // Handle the audit log response
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.target.id === 'audit-response') {
                // Try to format JSON response nicely
                try {
                    const data = JSON.parse(evt.detail.target.innerHTML);
                    evt.detail.target.innerHTML = `
                        <div class="bg-green-50 border border-green-300 rounded p-3">
                            <p class="text-green-800 font-semibold">✓ Test record created!</p>
                            <p class="text-sm text-green-700 mt-1">ID: ${data.id}, Level: ${data.level}, Message: ${data.message}</p>
                        </div>
                    `;
                } catch (e) {
                    // Not JSON, leave as is
                }
            }
        });
    </script>
</div>
{% endblock %}
