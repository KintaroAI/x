{% extends "base.html" %}

{% block title %}Weekly Calendar - X Scheduler{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header with navigation -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Weekly Calendar</h1>
                <p id="week-range" class="text-gray-600">Loading week...</p>
            </div>
            <div class="flex gap-2">
                <button 
                    onclick="navigateWeek('prev')" 
                    class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors inline-flex items-center"
                    title="Previous week"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                    Prev
                </button>
                <button 
                    onclick="navigateWeek('today')" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"
                    title="Go to current week"
                >
                    Today
                </button>
                <button 
                    onclick="navigateWeek('next')" 
                    class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors inline-flex items-center"
                    title="Next week"
                >
                    Next
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <!-- Day Headers -->
        <div id="day-headers" class="grid grid-cols-8 border-b border-gray-200 bg-gray-50">
            <div class="p-4 border-r border-gray-200 text-sm font-medium text-gray-500">Time</div>
            <div class="p-4 text-center text-sm font-medium text-gray-700"></div>
            <div class="p-4 text-center text-sm font-medium text-gray-700"></div>
            <div class="p-4 text-center text-sm font-medium text-gray-700"></div>
            <div class="p-4 text-center text-sm font-medium text-gray-700"></div>
            <div class="p-4 text-center text-sm font-medium text-gray-700"></div>
            <div class="p-4 text-center text-sm font-medium text-gray-700"></div>
            <div class="p-4 text-center text-sm font-medium text-gray-700"></div>
        </div>

        <!-- Calendar Grid Body -->
        <div id="calendar-grid" class="relative" style="height: 1440px; overflow-y: auto;">
            <!-- Time labels and day columns will be generated by JavaScript -->
        </div>
    </div>
</div>

<script>
// Calendar state
let currentWeekStart = null;
let currentTimezone = '{{ timezone }}';
let currentLocale = '{{ locale }}';
let calendarData = null;

// Initialize calendar on page load
document.addEventListener('DOMContentLoaded', function() {
    // Get week_start from URL or use current week
    const urlParams = new URLSearchParams(window.location.search);
    const weekStartParam = urlParams.get('week_start');
    
    loadWeekSchedule(weekStartParam);
});

// Load week schedule from API
async function loadWeekSchedule(weekStart = null) {
    try {
        const params = new URLSearchParams({
            timezone: currentTimezone,
            locale: currentLocale
        });
        if (weekStart) {
            params.append('week_start', weekStart);
        }
        
        const response = await fetch(`/api/calendar/week?${params}`);
        const data = await response.json();
        
        if (data.error) {
            console.error('Error loading schedule:', data.error);
            return;
        }
        
        calendarData = data;
        currentWeekStart = data.week_start;
        currentTimezone = data.timezone;
        currentLocale = data.locale;
        
        renderCalendar(data);
    } catch (error) {
        console.error('Error loading week schedule:', error);
    }
}

// Render calendar grid
function renderCalendar(data) {
    // Update week range display
    const weekStartDate = new Date(data.week_start);
    const weekEndDate = new Date(data.week_end);
    const weekRangeText = `${weekStartDate.toLocaleDateString()} - ${weekEndDate.toLocaleDateString()}`;
    document.getElementById('week-range').textContent = weekRangeText;
    
    // Render day headers
    renderDayHeaders(weekStartDate, data.locale);
    
    // Render time grid
    renderTimeGrid(data);
    
    // Render post blocks
    renderPostBlocks(data.occurrences);
}

// Render day headers
function renderDayHeaders(weekStart, locale) {
    const dayHeaders = document.getElementById('day-headers');
    const dayNames = locale === 'sunday' 
        ? ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
        : ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    
    // Clear existing (keep Time column)
    const timeCol = dayHeaders.children[0];
    dayHeaders.innerHTML = '';
    dayHeaders.appendChild(timeCol);
    
    // Add day headers
    const startDate = new Date(weekStart);
    for (let i = 0; i < 7; i++) {
        const date = new Date(startDate);
        date.setDate(date.getDate() + i);
        
        const dayDiv = document.createElement('div');
        dayDiv.className = 'p-4 text-center border-r border-gray-200';
        dayDiv.innerHTML = `
            <div class="text-sm font-medium text-gray-700">${dayNames[i]}</div>
            <div class="text-xs text-gray-500">${date.getDate()}</div>
        `;
        dayHeaders.appendChild(dayDiv);
    }
}

// Render time grid (48 rows for 30-minute slots)
function renderTimeGrid(data) {
    const grid = document.getElementById('calendar-grid');
    grid.innerHTML = '';
    
    // Calculate dimensions
    const totalHeight = 1440; // 24 hours * 60 minutes
    const slotHeight = totalHeight / 48; // 30 minutes per slot
    const timeColumnWidth = 80;
    
    // Calculate day column width as percentage
    const dayColumnWidthPercent = (100 - (timeColumnWidth / grid.offsetWidth * 100)) / 7;
    const dayColumnWidthPx = dayColumnWidthPercent * grid.offsetWidth / 100;
    
    // Generate time slots (00:00 to 23:30)
    for (let hour = 0; hour < 24; hour++) {
        for (let minute = 0; minute < 60; minute += 30) {
            const slotIndex = hour * 2 + (minute / 30);
            const top = slotIndex * slotHeight;
            
            // Time label column (only show on full hours)
            if (minute === 0) {
                const timeLabel = document.createElement('div');
                timeLabel.className = 'absolute border-r border-gray-200 bg-gray-50';
                timeLabel.style.left = '0';
                timeLabel.style.top = `${top}px`;
                timeLabel.style.width = `${timeColumnWidth}px`;
                timeLabel.style.height = `${slotHeight * 2}px`; // Span 2 slots (1 hour)
                timeLabel.style.paddingLeft = '8px';
                timeLabel.style.paddingTop = '4px';
                timeLabel.style.fontSize = '12px';
                timeLabel.style.color = '#6B7280';
                
                const timeText = `${hour.toString().padStart(2, '0')}:00`;
                timeLabel.textContent = timeText;
                grid.appendChild(timeLabel);
            }
            
            // Day columns (7 columns)
            for (let day = 0; day < 7; day++) {
                const dayCol = document.createElement('div');
                dayCol.className = 'absolute border-r border-b border-gray-200 bg-white';
                dayCol.style.left = `${timeColumnWidth + day * dayColumnWidthPx}px`;
                dayCol.style.top = `${top}px`;
                dayCol.style.width = `${dayColumnWidthPx}px`;
                dayCol.style.height = `${slotHeight}px`;
                dayCol.setAttribute('data-day', day);
                dayCol.setAttribute('data-slot', slotIndex);
                
                grid.appendChild(dayCol);
            }
        }
    }
}

// Render post blocks on calendar
function renderPostBlocks(occurrences) {
    if (!occurrences || occurrences.length === 0) {
        return;
    }
    
    const grid = document.getElementById('calendar-grid');
    const totalHeight = 1440;
    const slotHeight = totalHeight / 48;
    const timeColumnWidth = 80;
    const dayColumnWidth = (grid.offsetWidth - timeColumnWidth) / 7;
    
    occurrences.forEach(occurrence => {
        const scheduledTime = new Date(occurrence.scheduled_time_local);
        
        // Calculate position
        const hours = scheduledTime.getHours();
        const minutes = scheduledTime.getMinutes();
        const slotIndex = hours * 2 + Math.floor(minutes / 30);
        const top = slotIndex * slotHeight + ((minutes % 30) / 30) * slotHeight;
        
        // Get day of week (0-6, where 0 depends on locale)
        const dayOfWeek = scheduledTime.getDay();
        // Adjust for locale (sunday=0 vs monday=0)
        let dayIndex;
        if (calendarData.locale === 'sunday') {
            dayIndex = dayOfWeek; // Sunday=0
        } else {
            dayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Monday=0, Sunday=6
        }
        
        // Calculate block dimensions
        const durationSlots = occurrence.duration_minutes / 30;
        const height = Math.max(durationSlots * slotHeight, 20); // Minimum 20px
        const left = 80 + dayIndex * dayColumnWidth + 2; // 2px margin
        const width = dayColumnWidth - 4; // 4px total margin
        
        // Apply stack_index offset for overlapping posts
        const stackOffset = occurrence.stack_index * 4; // 4px per stack level
        const stackedWidth = width - (stackOffset * 2);
        const stackedLeft = left + stackOffset;
        
        // Create post block
        const block = document.createElement('div');
        block.className = 'absolute rounded cursor-pointer hover:shadow-lg transition-shadow border-l-4';
        block.style.left = `${stackedLeft}px`;
        block.style.top = `${top}px`;
        block.style.width = `${stackedWidth}px`;
        block.style.height = `${height}px`;
        block.style.backgroundColor = occurrence.color_hint || '#3B82F6';
        block.style.borderLeftColor = occurrence.color_hint || '#3B82F6';
        block.style.opacity = '0.9';
        block.style.zIndex = 10 + occurrence.stack_index;
        
        // Block content
        block.innerHTML = `
            <div class="p-1 text-white text-xs overflow-hidden" style="height: 100%;">
                <div class="font-semibold truncate" title="${escapeHtml(occurrence.post_text_preview)}">
                    ${escapeHtml(occurrence.post_text_preview)}
                </div>
                <div class="text-xs opacity-90 mt-0.5">
                    ${scheduledTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </div>
            </div>
        `;
        
        // Click handler to navigate to post view
        block.onclick = function() {
            window.location.href = `/view-post/${occurrence.post_id}`;
        };
        
        // Tooltip on hover
        block.title = `${occurrence.post_text_preview}\nPost #${occurrence.post_id}\n${scheduledTime.toLocaleString()}`;
        
        grid.appendChild(block);
    });
}

// Navigate to previous/next week or today
function navigateWeek(direction) {
    if (!calendarData) return;
    
    let newWeekStart;
    const current = new Date(calendarData.week_start);
    
    if (direction === 'prev') {
        current.setDate(current.getDate() - 7);
        newWeekStart = current.toISOString().split('T')[0];
    } else if (direction === 'next') {
        current.setDate(current.getDate() + 7);
        newWeekStart = current.toISOString().split('T')[0];
    } else if (direction === 'today') {
        // Go to current week
        newWeekStart = null;
    }
    
    // Update URL and reload
    const url = new URL(window.location);
    if (newWeekStart) {
        url.searchParams.set('week_start', newWeekStart);
    } else {
        url.searchParams.delete('week_start');
    }
    window.location.href = url.toString();
}

// Helper function to escape HTML
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}
</script>

<style>
/* Additional styles for calendar */
#calendar-grid {
    scrollbar-width: thin;
    scrollbar-color: #CBD5E1 #F3F4F6;
}

#calendar-grid::-webkit-scrollbar {
    width: 8px;
}

#calendar-grid::-webkit-scrollbar-track {
    background: #F3F4F6;
}

#calendar-grid::-webkit-scrollbar-thumb {
    background: #CBD5E1;
    border-radius: 4px;
}

#calendar-grid::-webkit-scrollbar-thumb:hover {
    background: #94A3B8;
}
</style>
{% endblock %}

