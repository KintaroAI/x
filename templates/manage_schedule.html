{% extends "base.html" %}

{% block title %}Manage Schedule - X Scheduler{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Manage Schedule #{{ schedule.id }}</h1>
    
    <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Schedule Information</h2>
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div>
                <label class="text-sm font-medium text-gray-500">Kind</label>
                <p class="text-lg font-semibold">{{ schedule.kind }}</p>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-500">Status</label>
                <p class="text-lg font-semibold {% if schedule.enabled %}text-green-600{% else %}text-gray-500{% endif %}">
                    {% if schedule.enabled %}Enabled{% else %}Disabled{% endif %}
                </p>
            </div>
            {% if schedule.next_run_at %}
            <div>
                <label class="text-sm font-medium text-gray-500">Next Run</label>
                <p class="text-lg">{{ schedule.next_run_at|datetime_tz }}</p>
            </div>
            {% endif %}
            {% if schedule.post_id %}
            <div>
                <label class="text-sm font-medium text-gray-500">Post ID</label>
                <p class="text-lg"><a href="/view-post/{{ schedule.post_id }}" class="text-blue-600 hover:text-blue-800">#{{ schedule.post_id }}</a></p>
            </div>
            {% endif %}
            {% if schedule.template_id %}
            <div>
                <label class="text-sm font-medium text-gray-500">Template ID</label>
                <p class="text-lg"><a href="/template/{{ schedule.template_id }}" class="text-blue-600 hover:text-blue-800">#{{ schedule.template_id }}</a></p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Template and Selection Policy Section -->
    <div class="bg-white rounded-lg shadow-lg p-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Template & Selection Policy</h2>
        
        <form id="schedule-form" hx-post="/api/schedules/{{ schedule.id }}" hx-target="#result" hx-swap="innerHTML">
            <div class="mb-6">
                <label for="template_id" class="block text-sm font-medium text-gray-700 mb-2">
                    Template (Optional - leave empty to use post-based)
                </label>
                <select 
                    id="template_id" 
                    name="template_id"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="0">None (use post-based)</option>
                    {% for template in templates %}
                    <option value="{{ template.id }}" {% if schedule.template_id == template.id %}selected{% endif %}>
                        {{ template.name }}
                    </option>
                    {% endfor %}
                </select>
                <p class="mt-2 text-sm text-gray-500">Select a template to enable variant selection, or leave as "None" to use post-based scheduling</p>
            </div>
            
            <div class="mb-6">
                <label for="selection_policy" class="block text-sm font-medium text-gray-700 mb-2">
                    Selection Policy
                </label>
                <select 
                    id="selection_policy" 
                    name="selection_policy"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="RANDOM_UNIFORM" {% if schedule.selection_policy == 'RANDOM_UNIFORM' %}selected{% endif %}>Random Uniform</option>
                    <option value="RANDOM_WEIGHTED" {% if schedule.selection_policy == 'RANDOM_WEIGHTED' %}selected{% endif %}>Random Weighted</option>
                    <option value="ROUND_ROBIN" {% if schedule.selection_policy == 'ROUND_ROBIN' %}selected{% endif %}>Round Robin</option>
                    <option value="NO_REPEAT_WINDOW" {% if schedule.selection_policy == 'NO_REPEAT_WINDOW' %}selected{% endif %}>No Repeat Window</option>
                </select>
                <p class="mt-2 text-sm text-gray-500">
                    <strong>Random Uniform:</strong> Equal probability for all variants<br>
                    <strong>Random Weighted:</strong> Weighted probability based on variant weights<br>
                    <strong>Round Robin:</strong> Cycle through variants in order<br>
                    <strong>No Repeat Window:</strong> Exclude recently used variants
                </p>
            </div>
            
            <div class="mb-6">
                <label for="no_repeat_window" class="block text-sm font-medium text-gray-700 mb-2">
                    No Repeat Window
                </label>
                <input 
                    type="number" 
                    id="no_repeat_window" 
                    name="no_repeat_window"
                    min="0"
                    value="{{ schedule.no_repeat_window }}"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <p class="mt-2 text-sm text-gray-500">Number of recent fires to exclude from selection (0 = disabled)</p>
            </div>
            
            <div class="mb-6">
                <label for="no_repeat_scope" class="block text-sm font-medium text-gray-700 mb-2">
                    No Repeat Scope
                </label>
                <select 
                    id="no_repeat_scope" 
                    name="no_repeat_scope"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="template" {% if schedule.no_repeat_scope == 'template' %}selected{% endif %}>Template (across all schedules)</option>
                    <option value="schedule" {% if schedule.no_repeat_scope == 'schedule' %}selected{% endif %}>Schedule (this schedule only)</option>
                </select>
                <p class="mt-2 text-sm text-gray-500">Whether to exclude variants across all schedules with this template, or just this schedule</p>
            </div>
            
            <div id="result" class="mb-4"></div>
            
            <div class="flex gap-4">
                <button 
                    type="submit" 
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                    Update Schedule
                </button>
                <a 
                    href="/" 
                    class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition-colors font-semibold">
                    Cancel
                </a>
            </div>
        </form>
    </div>
    
    {% if schedule.template_id %}
    <!-- Preview Section -->
    <div class="bg-white rounded-lg shadow-lg p-8 mt-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Preview Variant Selection</h2>
        <div class="mb-4">
            <label for="preview_datetime" class="block text-sm font-medium text-gray-700 mb-2">
                Planned At (Optional - defaults to next_run_at)
            </label>
            <input 
                type="datetime-local" 
                id="preview_datetime" 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <button 
            onclick="previewSelection()"
            class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors font-semibold">
            Preview Selection
        </button>
        <div id="preview-result" class="mt-4 p-4 border border-gray-200 rounded-lg hidden">
            <h3 class="font-semibold text-gray-900 mb-2">Selected Variant:</h3>
            <div id="preview-content"></div>
        </div>
    </div>
    
    <script>
        function previewSelection() {
            const datetime = document.getElementById('preview_datetime').value;
            const previewResult = document.getElementById('preview-result');
            const previewContent = document.getElementById('preview-content');
            
            let url = `/api/schedules/{{ schedule.id }}/preview`;
            if (datetime) {
                // Convert datetime-local to ISO format
                const dt = new Date(datetime);
                url += `?planned_at=${dt.toISOString()}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        previewContent.innerHTML = `<p class="text-red-600">${data.error}</p>`;
                    } else {
                        previewContent.innerHTML = `
                            <p class="text-gray-900 mb-2"><strong>Variant ID:</strong> ${data.variant_id}</p>
                            <p class="text-gray-900 mb-2"><strong>Text:</strong> ${data.variant_text}</p>
                            <p class="text-gray-600 text-sm"><strong>Policy:</strong> ${data.selection_policy}</p>
                            <p class="text-gray-600 text-sm"><strong>Seed:</strong> ${data.selection_seed}</p>
                            <p class="text-gray-600 text-sm"><strong>Planned At:</strong> ${new Date(data.planned_at).toLocaleString()}</p>
                        `;
                    }
                    previewResult.classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error previewing selection:', error);
                    previewContent.innerHTML = `<p class="text-red-600">Error previewing selection</p>`;
                    previewResult.classList.remove('hidden');
                });
        }
    </script>
    {% endif %}
</div>
{% endblock %}

