{% extends "base.html" %}

{% block title %}{% if is_edit %}Edit Template{% else %}Create Template{% endif %} - X Scheduler{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">{% if is_edit %}Edit Template{% else %}Create New Template{% endif %}</h1>
    
    <div class="bg-white rounded-lg shadow-lg p-8">
        <form id="template-form" hx-post="{% if is_edit %}/api/templates/{{ template.id }}{% else %}/api/templates{% endif %}" hx-target="#result" hx-swap="innerHTML">
            <div class="mb-6">
                <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                    Template Name *
                </label>
                <input 
                    type="text" 
                    id="name" 
                    name="name" 
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="e.g., Daily Motivation Quotes"
                    value="{% if template %}{{ template.name }}{% endif %}">
            </div>
            
            <div class="mb-6">
                <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                    Description (Optional)
                </label>
                <textarea 
                    id="description" 
                    name="description" 
                    rows="3" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                    placeholder="Describe what this template is for...">{% if template %}{{ template.description or '' }}{% endif %}</textarea>
            </div>
            
            {% if is_edit %}
            <div class="mb-6">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input 
                        type="checkbox" 
                        id="active" 
                        name="active"
                        class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
                        {% if template and template.active %}checked{% endif %}>
                    <span class="text-sm font-medium text-gray-700">Active</span>
                </label>
                <p class="mt-1 text-sm text-gray-500">Inactive templates won't be used by schedules</p>
            </div>
            {% endif %}
            
            <div id="result"></div>
            
            <div class="flex gap-4">
                <button 
                    type="submit" 
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                    {% if is_edit %}Update Template{% else %}Create Template{% endif %}
                </button>
                <a 
                    href="/templates" 
                    class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition-colors font-semibold">
                    Cancel
                </a>
                {% if is_edit %}
                <a 
                    href="/template/{{ template.id }}" 
                    class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition-colors font-semibold">
                    View Template
                </a>
                {% endif %}
            </div>
        </form>
    </div>
    
    {% if is_edit and template %}
    <!-- Variants Section -->
    <div class="bg-white rounded-lg shadow-lg p-8 mt-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-semibold text-gray-800">Variants</h2>
            <a href="/template/{{ template.id }}/add-variant" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors font-semibold text-sm">
                + Add Variant
            </a>
        </div>
        
        <div id="variants-container" class="space-y-4">
            <p class="text-gray-600 text-center">Loading variants...</p>
        </div>
    </div>
    
    <script>
        // Load variants when editing
        document.addEventListener('DOMContentLoaded', function() {
            loadVariants({{ template.id }});
        });
        
        function loadVariants(templateId) {
            fetch(`/api/templates/${templateId}/variants`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('variants-container');
                    
                    if (data.error) {
                        container.innerHTML = `<p class="text-red-600 text-center">${data.error}</p>`;
                        return;
                    }
                    
                    if (data.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-8 border-2 border-dashed border-gray-300 rounded-lg">
                                <p class="text-gray-600 mb-4">No variants yet.</p>
                                <a href="/template/${templateId}/add-variant" class="text-blue-600 hover:text-blue-800 font-semibold">Add your first variant â†’</a>
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = data.map(variant => `
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow ${variant.active ? '' : 'opacity-60'}">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <span class="px-2 py-1 bg-gray-100 text-gray-800 text-xs font-semibold rounded">Weight: ${variant.weight}</span>
                                        ${variant.active ? 
                                            '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded">Active</span>' : 
                                            '<span class="px-2 py-1 bg-gray-100 text-gray-800 text-xs font-semibold rounded">Inactive</span>'
                                        }
                                    </div>
                                    <p class="text-gray-900 mb-2">${variant.text}</p>
                                    <div class="text-sm text-gray-500">
                                        ${variant.text.length}/280 characters
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <a href="/variant/${variant.id}/edit" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition-colors text-sm">
                                        Edit
                                    </a>
                                    <button onclick="deleteVariant(${variant.id}, ${templateId})" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 transition-colors text-sm">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error loading variants:', error);
                    document.getElementById('variants-container').innerHTML = 
                        '<p class="text-red-600 text-center">Error loading variants.</p>';
                });
        }
        
        function deleteVariant(variantId, templateId) {
            Swal.fire({
                title: 'Delete Variant?',
                text: 'Are you sure? This action cannot be undone.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/api/variants/${variantId}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            Swal.fire('Error', data.error, 'error');
                        } else {
                            Swal.fire('Deleted!', 'Variant has been deleted.', 'success');
                            loadVariants(templateId);
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting variant:', error);
                        Swal.fire('Error', 'Failed to delete variant.', 'error');
                    });
                }
            });
        }
    </script>
    {% endif %}
</div>
{% endblock %}

